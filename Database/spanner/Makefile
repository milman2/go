# Makefile for Google Cloud Spanner + yo

# Spanner ì„¤ì •
SPANNER_EMULATOR_HOST=localhost:9010
SPANNER_PROJECT_ID=test-project
SPANNER_INSTANCE_ID=test-instance
SPANNER_DATABASE_ID=test-database

# ê²½ë¡œ ì„¤ì •
MIGRATIONS_DIR=migrations
MODELS_DIR=models

# ìƒ‰ìƒ ì¶œë ¥
GREEN=\033[0;32m
YELLOW=\033[1;33m
NC=\033[0m

.PHONY: help
help: ## ë„ì›€ë§ ì¶œë ¥
	@echo "$(GREEN)Spanner + yo Makefile Commands$(NC)"
	@echo "=================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'

.PHONY: docker-up
docker-up: ## Docker Spanner emulator ì‹œì‘
	@echo "$(GREEN)ğŸ³ Starting Spanner emulator...$(NC)"
	docker-compose up -d spanner
	@echo "$(GREEN)âœ… Spanner emulator started on :9010 (gRPC), :9020 (HTTP)$(NC)"

.PHONY: docker-down
docker-down: ## Docker Spanner emulator ì¤‘ì§€
	@echo "$(YELLOW)ğŸ›‘ Stopping Spanner emulator...$(NC)"
	docker-compose down

.PHONY: docker-ps
docker-ps: ## Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
	docker-compose ps

.PHONY: setup-instance
setup-instance: ## Spanner Instanceì™€ Database ìƒì„±
	@echo "$(GREEN)ğŸ“¦ Creating Spanner instance and database...$(NC)"
	@gcloud config set auth/disable_credentials true
	@gcloud config set project $(SPANNER_PROJECT_ID)
	@gcloud config set api_endpoint_overrides/spanner http://localhost:9020/
	@gcloud spanner instances create $(SPANNER_INSTANCE_ID) \
		--config=emulator-config \
		--description="Test Instance" \
		--nodes=1 || true
	@gcloud spanner databases create $(SPANNER_DATABASE_ID) \
		--instance=$(SPANNER_INSTANCE_ID) || true
	@echo "$(GREEN)âœ… Instance and database ready$(NC)"

.PHONY: migrate-up-hammer
migrate-up-hammer: ## Hammerë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ UP
	@echo "$(GREEN)ğŸ”¨ Running migrations with Hammer...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		hammer -p $(SPANNER_PROJECT_ID) -i $(SPANNER_INSTANCE_ID) -d $(SPANNER_DATABASE_ID) \
		-m $(MIGRATIONS_DIR) up
	@echo "$(GREEN)âœ… Hammer migration completed$(NC)"

.PHONY: migrate-down-hammer
migrate-down-hammer: ## Hammerë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ DOWN
	@echo "$(YELLOW)â¬‡ï¸ Rolling back migrations with Hammer...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		hammer -p $(SPANNER_PROJECT_ID) -i $(SPANNER_INSTANCE_ID) -d $(SPANNER_DATABASE_ID) \
		-m $(MIGRATIONS_DIR) down
	@echo "$(GREEN)âœ… Hammer rollback completed$(NC)"

.PHONY: migrate-up-wrench
migrate-up-wrench: ## Wrenchë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ UP
	@echo "$(GREEN)ğŸ”§ Running migrations with Wrench...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		wrench migrate up \
		--directory $(MIGRATIONS_DIR) \
		--database projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID)
	@echo "$(GREEN)âœ… Wrench migration completed$(NC)"

.PHONY: migrate-down-wrench
migrate-down-wrench: ## Wrenchë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ DOWN
	@echo "$(YELLOW)â¬‡ï¸ Rolling back migrations with Wrench...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		wrench migrate down \
		--directory $(MIGRATIONS_DIR) \
		--database projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID)
	@echo "$(GREEN)âœ… Wrench rollback completed$(NC)"

.PHONY: generate-yo
generate-yo: ## yoë¡œ ì½”ë“œ ìƒì„± (ìŠ¤í‚¤ë§ˆ â†’ Go ì½”ë“œ)
	@echo "$(GREEN)ğŸ”¨ Generating code with yo...$(NC)"
	@rm -rf $(MODELS_DIR)
	@mkdir -p $(MODELS_DIR)
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		yo $(SPANNER_PROJECT_ID) $(SPANNER_INSTANCE_ID) $(SPANNER_DATABASE_ID) \
		-o $(MODELS_DIR) -p models
	@echo "$(GREEN)âœ… Code generation completed: $(MODELS_DIR)/$(NC)"
	@ls -lh $(MODELS_DIR)/

.PHONY: install-tools
install-tools: ## í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜
	@echo "$(GREEN)ğŸ“¦ Installing tools...$(NC)"
	@echo "Installing hammer..."
	@go install github.com/daichirata/hammer@v0.6.0
	@echo "Installing wrench..."
	@go install github.com/cloudspannerecosystem/wrench@v1.0.4
	@echo "Installing yo..."
	@go install go.mercari.io/yo@latest
	@echo "$(GREEN)âœ… All tools installed$(NC)"
	@echo "  - hammer: $(shell which hammer)"
	@echo "  - wrench: $(shell which wrench)"
	@echo "  - yo: $(shell which yo)"

.PHONY: init
init: docker-up install-tools setup-instance migrate-up-wrench generate-yo ## ì „ì²´ ì´ˆê¸°í™” (í•œë²ˆì—)
	@echo ""
	@echo "$(GREEN)ğŸ‰ Spanner í™˜ê²½ ì´ˆê¸°í™” ì™„ë£Œ!$(NC)"
	@echo "=================================="
	@echo "  âœ… Docker Spanner emulator ì‹¤í–‰"
	@echo "  âœ… Instance & Database ìƒì„±"
	@echo "  âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"
	@echo "  âœ… yo ì½”ë“œ ìƒì„± ì™„ë£Œ"
	@echo ""
	@echo "$(YELLOW)ğŸ“ ë‹¤ìŒ ë‹¨ê³„:$(NC)"
	@echo "  make run          # ì„œë²„ ì‹¤í–‰"
	@echo "  make test         # API í…ŒìŠ¤íŠ¸"

.PHONY: clean
clean: ## ìƒì„±ëœ íŒŒì¼ ì •ë¦¬
	@echo "$(YELLOW)ğŸ§¹ Cleaning up...$(NC)"
	@rm -rf $(MODELS_DIR)
	@echo "$(GREEN)âœ… Cleaned$(NC)"

.PHONY: reset
reset: migrate-down-wrench migrate-up-wrench generate-yo ## DB ë¦¬ì…‹ ë° ì½”ë“œ ì¬ìƒì„±
	@echo "$(GREEN)âœ… Database reset and code regenerated$(NC)"

.PHONY: run
run: ## ì„œë²„ ì‹¤í–‰
	@echo "$(GREEN)ğŸš€ Starting server...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) go run cmd/api/main.go

.PHONY: test
test: ## API í…ŒìŠ¤íŠ¸
	@echo "$(GREEN)ğŸ§ª Running tests...$(NC)"
	@./test.sh

.PHONY: spanner-cli
spanner-cli: ## Spanner CLI ì ‘ì†
	@echo "$(GREEN)ğŸ’» Connecting to Spanner CLI...$(NC)"
	docker-compose exec spanner-cli spanner-cli -p $(SPANNER_PROJECT_ID) -i $(SPANNER_INSTANCE_ID) -d $(SPANNER_DATABASE_ID)

.PHONY: show-schema
show-schema: ## í˜„ì¬ ìŠ¤í‚¤ë§ˆ í™•ì¸
	@echo "$(GREEN)ğŸ“‹ Current schema:$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		wrench migrate status \
		--directory $(MIGRATIONS_DIR) \
		--database projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID)

.PHONY: info
info: ## í˜„ì¬ ì„¤ì • ì •ë³´
	@echo "$(GREEN)â„¹ï¸ Spanner Configuration$(NC)"
	@echo "=================================="
	@echo "Emulator Host: $(SPANNER_EMULATOR_HOST)"
	@echo "Project ID:    $(SPANNER_PROJECT_ID)"
	@echo "Instance ID:   $(SPANNER_INSTANCE_ID)"
	@echo "Database ID:   $(SPANNER_DATABASE_ID)"
	@echo ""
	@echo "Ports:"
	@echo "  gRPC: :9010"
	@echo "  HTTP: :9020"
	@echo ""
	@echo "Docker Status:"
	@docker ps --filter "name=spanner" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

