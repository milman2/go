# Makefile for Google Cloud Spanner + hammer + yo

# Makefile path information
MAKEFILE_PATH:=$(abspath $(lastword $(MAKEFILE_LIST)))
MAKEFILE_DIR:=$(patsubst %/,%,$(dir ${MAKEFILE_PATH}))

# Directories
CWD_DIR:=${MAKEFILE_DIR:%/=%}
BIN_DIR:=${CWD_DIR}/bin
EXT_BIN_DIR:=${BIN_DIR}/ext

# Spanner ì„¤ì •
SPANNER_EMULATOR_HOST=localhost:9010
SPANNER_PROJECT_ID=test-project
SPANNER_INSTANCE_ID=test-instance
SPANNER_DATABASE_ID=test-db

# ê²½ë¡œ ì„¤ì •
SCHEMA_DIR=schema
SCHEMA_FILE=${SCHEMA_DIR}/schema.sql
MIGRATIONS_DIR=migrations
MODELS_DIR=models

# ìƒ‰ìƒ ì¶œë ¥
GREEN=\033[0;32m
YELLOW=\033[1;33m
NC=\033[0m

.PHONY: help
help: ## ë„ì›€ë§ ì¶œë ¥
	@echo "$(GREEN)Spanner + yo Makefile Commands$(NC)"
	@echo "=================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'

.PHONY: docker-up
docker-up: ## Docker Spanner emulator ì‹œì‘
	@echo "$(GREEN)ğŸ³ Starting Spanner emulator...$(NC)"
	docker-compose up -d spanner
	@echo "$(GREEN)âœ… Spanner emulator started on :9010 (gRPC), :9020 (HTTP)$(NC)"

.PHONY: docker-down
docker-down: ## Docker Spanner emulator ì¤‘ì§€
	@echo "$(YELLOW)ğŸ›‘ Stopping Spanner emulator...$(NC)"
	docker-compose down

.PHONY: docker-ps
docker-ps: ## Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
	docker-compose ps

.PHONY: setup-instance
setup-instance: ## Spanner Instance ìƒì„± (ë°ì´í„°ë² ì´ìŠ¤ëŠ” createdbì—ì„œ ìƒì„±)
	@echo "$(GREEN)ğŸ“¦ Creating Spanner instance...$(NC)"
	@gcloud config set auth/disable_credentials true
	@gcloud config set project $(SPANNER_PROJECT_ID)
	@gcloud config set api_endpoint_overrides/spanner http://localhost:9020/
	@gcloud spanner instances create $(SPANNER_INSTANCE_ID) \
		--config=emulator-config \
		--description="Test Instance" \
		--nodes=1 || true
	@echo "$(GREEN)âœ… Instance ready$(NC)"

.PHONY: createdb
createdb: ${EXT_BIN_DIR}/wrench ${EXT_BIN_DIR}/hammer ## Spanner ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± (hammer create ì‚¬ìš©)
	@echo "$(GREEN)ğŸ”¨ Creating database with hammer...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/wrench drop --project $(SPANNER_PROJECT_ID) --instance $(SPANNER_INSTANCE_ID) --database $(SPANNER_DATABASE_ID) 2>/dev/null || true
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/hammer create spanner://projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID) $(SCHEMA_FILE)
	@echo "$(GREEN)âœ… Database created from $(SCHEMA_FILE)$(NC)"

.PHONY: db-apply
db-apply: ${EXT_BIN_DIR}/hammer ## ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ ì ìš© (hammer apply ì‚¬ìš©)
	@echo "$(GREEN)ğŸ”¨ Applying schema changes with hammer...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/hammer apply spanner://projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID) $(SCHEMA_FILE)
	@echo "$(GREEN)âœ… Schema changes applied$(NC)"

.PHONY: db-diff
db-diff: ${EXT_BIN_DIR}/hammer ## í˜„ì¬ DBì™€ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì°¨ì´ í™•ì¸ (hammer diff ì‚¬ìš©)
	@echo "$(GREEN)ğŸ” Checking schema differences...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/hammer diff spanner://projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID) $(SCHEMA_FILE)

.PHONY: db-export
db-export: ${EXT_BIN_DIR}/hammer ## í˜„ì¬ ìŠ¤í‚¤ë§ˆë¥¼ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸° (hammer export ì‚¬ìš©)
	@echo "$(GREEN)ğŸ“¤ Exporting schema with hammer...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/hammer export spanner://projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID) > exported_schema.sql
	@echo "$(GREEN)âœ… Schema exported to exported_schema.sql$(NC)"

.PHONY: dropdb
dropdb: ${EXT_BIN_DIR}/wrench ## ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ (wrench drop ì‚¬ìš©)
	@echo "$(YELLOW)âš ï¸  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤!$(NC)"
	@read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "$(YELLOW)Dropping database...$(NC)"; \
		SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/wrench drop --project $(SPANNER_PROJECT_ID) --instance $(SPANNER_INSTANCE_ID) --database $(SPANNER_DATABASE_ID); \
		echo "$(GREEN)âœ… Database dropped$(NC)"; \
	fi

.PHONY: resetdb
resetdb: createdb ## ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ (ì‚­ì œ í›„ ì¬ìƒì„±)
	@echo "$(GREEN)âœ… Database reset completed$(NC)"

.PHONY: seed-data
seed-data: ## ìƒ˜í”Œ ë°ì´í„° ì‚½ì… (Go ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©)
	@echo "$(GREEN)ğŸŒ± Seeding sample data...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		SPANNER_PROJECT_ID=$(SPANNER_PROJECT_ID) \
		SPANNER_INSTANCE_ID=$(SPANNER_INSTANCE_ID) \
		SPANNER_DATABASE_ID=$(SPANNER_DATABASE_ID) \
		go run scripts/seed_data.go
	@echo "$(GREEN)âœ… Sample data seeded$(NC)"

.PHONY: clear-data
clear-data: ## ëª¨ë“  ë°ì´í„° ì‚­ì œ (í…Œì´ë¸” êµ¬ì¡°ëŠ” ìœ ì§€)
	@echo "$(YELLOW)âš ï¸  ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤!$(NC)"
	@read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "$(YELLOW)ğŸ—‘ï¸  Clearing all data...$(NC)"; \
		SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		gcloud spanner databases execute-sql $(SPANNER_DATABASE_ID) \
			--instance=$(SPANNER_INSTANCE_ID) \
			--sql="DELETE FROM posts WHERE TRUE; DELETE FROM users WHERE TRUE;" || true; \
		echo "$(GREEN)âœ… All data cleared$(NC)"; \
	fi

.PHONY: test-query
test-query: ## ìƒ˜í”Œ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
	@echo "$(GREEN)ğŸ” Running test queries...$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“Š Users count:$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		gcloud spanner databases execute-sql $(SPANNER_DATABASE_ID) \
		--instance=$(SPANNER_INSTANCE_ID) \
		--sql="SELECT COUNT(*) as user_count FROM users"
	@echo ""
	@echo "$(YELLOW)ğŸ“Š Posts count:$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		gcloud spanner databases execute-sql $(SPANNER_DATABASE_ID) \
		--instance=$(SPANNER_INSTANCE_ID) \
		--sql="SELECT COUNT(*) as post_count FROM posts"
	@echo ""
	@echo "$(YELLOW)ğŸ“Š Published posts by user:$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		gcloud spanner databases execute-sql $(SPANNER_DATABASE_ID) \
		--instance=$(SPANNER_INSTANCE_ID) \
		--sql="SELECT u.name, COUNT(p.id) as post_count FROM users u LEFT JOIN posts p ON u.id = p.user_id WHERE p.published = TRUE OR p.published IS NULL GROUP BY u.name ORDER BY post_count DESC"

.PHONY: generate-migration
generate-migration: ${EXT_BIN_DIR}/hammer ## ìŠ¤í‚¤ë§ˆ diff ê¸°ë°˜ ë§ˆì´ê·¸ë ˆì´ì…˜ í…œí”Œë¦¿ ìƒì„±
	@./scripts/generate_migration.sh

.PHONY: migrate-dml
migrate-dml: ${EXT_BIN_DIR}/wrench ## DML ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (wrench apply --dml) - ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨
	@echo "$(YELLOW)âš ï¸  ì´ ëª…ë ¹ì–´ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.$(NC)"
	@echo "$(YELLOW)ëŒ€ì‹  'make seed-data'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.$(NC)"

.PHONY: generate-models
generate-models: ${EXT_BIN_DIR}/yo ## yoë¡œ ì½”ë“œ ìƒì„± (ìŠ¤í‚¤ë§ˆ â†’ Go ì½”ë“œ)
	@echo "$(GREEN)ğŸ”¨ Generating code with yo...$(NC)"
	@rm -rf $(MODELS_DIR)/*.yo.go
	@mkdir -p $(MODELS_DIR)
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/yo $(SPANNER_PROJECT_ID) $(SPANNER_INSTANCE_ID) $(SPANNER_DATABASE_ID) \
		-o $(MODELS_DIR) -p models --ignore-tables SchemaMigrations
	@echo "$(GREEN)âœ… Code generation completed: $(MODELS_DIR)/$(NC)"
	@ls -lh $(MODELS_DIR)/*.yo.go

.PHONY: build/ext
build/ext: ${EXT_BIN_DIR}/hammer ${EXT_BIN_DIR}/wrench ${EXT_BIN_DIR}/yo ## ì™¸ë¶€ ë„êµ¬ ë¹Œë“œ (hammer, wrench, yo)
	@echo "$(GREEN)âœ… External tools built$(NC)"
	@echo "  - hammer: ${EXT_BIN_DIR}/hammer"
	@echo "  - wrench: ${EXT_BIN_DIR}/wrench"
	@echo "  - yo: ${EXT_BIN_DIR}/yo"

${EXT_BIN_DIR}/%: go.mod go.sum ${CWD_DIR}/ext/%.go
	@mkdir -p $(dir $@)
	@echo "$(GREEN)ğŸ“¦ Building $(notdir $@)...$(NC)"
	@GO_ARTIFACT_PATH=$@ go generate -tags ext $(patsubst ${EXT_BIN_DIR}/%,${CWD_DIR}/ext/%.go,$@)

.PHONY: init
init: docker-up build/ext setup-instance createdb generate-models ## ì „ì²´ ì´ˆê¸°í™” (í•œë²ˆì—)
	@echo ""
	@echo "$(GREEN)ğŸ‰ Spanner í™˜ê²½ ì´ˆê¸°í™” ì™„ë£Œ!$(NC)"
	@echo "=================================="
	@echo "  âœ… Docker Spanner emulator ì‹¤í–‰"
	@echo "  âœ… ì™¸ë¶€ ë„êµ¬ ë¹Œë“œ (hammer, wrench, yo)"
	@echo "  âœ… Instance ìƒì„±"
	@echo "  âœ… Database ë° ìŠ¤í‚¤ë§ˆ ìƒì„± (hammer)"
	@echo "  âœ… yo ì½”ë“œ ìƒì„± ì™„ë£Œ"
	@echo ""
	@echo "$(YELLOW)ğŸ“ ë‹¤ìŒ ë‹¨ê³„:$(NC)"
	@echo "  make run          # ì„œë²„ ì‹¤í–‰"
	@echo "  make test         # API í…ŒìŠ¤íŠ¸"
	@echo "  make db-diff      # ìŠ¤í‚¤ë§ˆ ì°¨ì´ í™•ì¸"
	@echo "  make db-apply     # ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì ìš©"

.PHONY: clean
clean: ## ìƒì„±ëœ íŒŒì¼ ì •ë¦¬
	@echo "$(YELLOW)ğŸ§¹ Cleaning up...$(NC)"
	@rm -rf $(MODELS_DIR)
	@echo "$(GREEN)âœ… Cleaned$(NC)"

.PHONY: reset
reset: resetdb generate-models ## DB ë¦¬ì…‹ ë° ì½”ë“œ ì¬ìƒì„±
	@echo "$(GREEN)âœ… Database reset and code regenerated$(NC)"

.PHONY: run
run: ## ì„œë²„ ì‹¤í–‰
	@echo "$(GREEN)ğŸš€ Starting server...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) go run cmd/api/main.go

.PHONY: test
test: ## API í…ŒìŠ¤íŠ¸
	@echo "$(GREEN)ğŸ§ª Running tests...$(NC)"
	@./test.sh

.PHONY: spanner-cli
spanner-cli: ## Spanner CLI ì ‘ì†
	@echo "$(GREEN)ğŸ’» Connecting to Spanner CLI...$(NC)"
	docker-compose exec spanner-cli spanner-cli -p $(SPANNER_PROJECT_ID) -i $(SPANNER_INSTANCE_ID) -d $(SPANNER_DATABASE_ID)

.PHONY: show-schema
show-schema: ${EXT_BIN_DIR}/hammer ## í˜„ì¬ ìŠ¤í‚¤ë§ˆ í™•ì¸ (hammer export)
	@echo "$(GREEN)ğŸ“‹ Current schema:$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		${EXT_BIN_DIR}/hammer export spanner://projects/$(SPANNER_PROJECT_ID)/instances/$(SPANNER_INSTANCE_ID)/databases/$(SPANNER_DATABASE_ID)

.PHONY: info
info: ## í˜„ì¬ ì„¤ì • ì •ë³´
	@echo "$(GREEN)â„¹ï¸ Spanner Configuration$(NC)"
	@echo "=================================="
	@echo "Emulator Host: $(SPANNER_EMULATOR_HOST)"
	@echo "Project ID:    $(SPANNER_PROJECT_ID)"
	@echo "Instance ID:   $(SPANNER_INSTANCE_ID)"
	@echo "Database ID:   $(SPANNER_DATABASE_ID)"
	@echo ""
	@echo "Ports:"
	@echo "  gRPC: :9010"
	@echo "  HTTP: :9020"
	@echo ""
	@echo "Docker Status:"
	@docker ps --filter "name=spanner" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

.PHONY: test-connection
test-connection: ## Spanner ì—°ê²° í…ŒìŠ¤íŠ¸ (Go)
	@echo "$(GREEN)ğŸ”Œ Spanner ì—°ê²° í…ŒìŠ¤íŠ¸...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) go run test_connection.go

.PHONY: test-tables
test-tables: ## í…Œì´ë¸” ì •ë³´ ì¡°íšŒ (Go)
	@echo "$(GREEN)ğŸ“Š í…Œì´ë¸” ì •ë³´ ì¡°íšŒ...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) go run test_tables.go

.PHONY: test-crud
test-crud: ## CRUD ì‘ì—… í…ŒìŠ¤íŠ¸ (Go)
	@echo "$(GREEN)ğŸ§ª CRUD í…ŒìŠ¤íŠ¸...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) go run test_crud.go

.PHONY: test-all
test-all: ## ì¢…í•© í…ŒìŠ¤íŠ¸ (ì—°ê²°+í…Œì´ë¸”+CRUD)
	@./test_all.sh

.PHONY: sql
sql: ## SQL ì‹¤í–‰ (ì‚¬ìš©: make sql SQL="SELECT * FROM users")
	@if [ -z "$(SQL)" ]; then \
		echo "$(YELLOW)ì‚¬ìš©ë²•: make sql SQL=\"SELECT * FROM users\"$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ” SQL ì‹¤í–‰...$(NC)"
	@SPANNER_EMULATOR_HOST=$(SPANNER_EMULATOR_HOST) \
		gcloud spanner databases execute-sql $(SPANNER_DATABASE_ID) \
		--instance=$(SPANNER_INSTANCE_ID) \
		--sql='$(SQL)'

